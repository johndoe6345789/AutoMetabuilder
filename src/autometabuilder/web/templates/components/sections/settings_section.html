{# Settings section macro. #}
{% from "components/atoms/section_header.html" import section_header %}
{% from "components/organisms/callout.html" import callout %}

{% macro settings_section() -%}
<section id="settings" class="amb-section">
    {{ section_header(t('ui.settings.title', 'Settings'), t('ui.settings.subtitle', 'Configure services, security, and environment preferences')) }}

    {{ callout(t('ui.settings.callout.title', 'Human-friendly settings'), t('ui.settings.callout.body', 'Each field explains what it does. Add descriptions in metadata.json to keep custom settings readable for everyone.'), "info", "info-circle") }}

    <form action="/settings" method="post" id="settings-form">
        <div class="row">
            {% set settings_desc = metadata.get('settings_descriptions', {}) %}

            <div class="col-lg-6">
                <div class="amb-card">
                    <div class="amb-card-header">
                        <h5><i class="bi bi-key"></i> {{ t('ui.settings.api_keys', 'API Keys') }}</h5>
                    </div>
                    <div class="amb-card-body">
                        {% for key in ['GITHUB_TOKEN', 'OPENAI_API_KEY', 'LITELLM_API_KEY'] %}
                        {% set desc = settings_desc.get(key, {}) %}
                        {% set desc_label = desc.get('label', key) %}
                        {% set desc_text = desc.get('description', '') %}
                        {% set desc_placeholder = desc.get('placeholder', '') %}
                        <div class="amb-form-group">
                            <label class="amb-form-label">
                                {{ t(desc_label, desc_label) }}
                                {% if desc.get('required') %}<span class="amb-required">*</span>{% endif %}
                            </label>
                            {% if desc_text %}
                            <p class="text-muted small mb-2">{{ t(desc_text, desc_text) }}</p>
                            {% endif %}
                            <input type="{{ desc.get('type', 'text') }}"
                                   name="env_{{ key }}"
                                   class="form-control"
                                   value="{{ env_vars.get(key, '') }}"
                                   placeholder="{{ t(desc_placeholder, desc_placeholder) }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="amb-card">
                    <div class="amb-card-header">
                        <h5><i class="bi bi-gear"></i> {{ t('ui.settings.configuration', 'Configuration') }}</h5>
                    </div>
                    <div class="amb-card-body">
                        {% for key in ['GITHUB_REPOSITORY', 'LOG_LEVEL', 'APP_LANG', 'PROMPT_PATH'] %}
                        {% set desc = settings_desc.get(key, {}) %}
                        {% set desc_label = desc.get('label', key) %}
                        {% set desc_text = desc.get('description', '') %}
                        {% set desc_placeholder = desc.get('placeholder', '') %}
                        <div class="amb-form-group">
                            <label class="amb-form-label">{{ t(desc_label, desc_label) }}</label>
                            {% if desc_text %}
                            <p class="text-muted small mb-2">{{ t(desc_text, desc_text) }}</p>
                            {% endif %}
                            {% if desc.get('type') == 'select' %}
                            <select name="env_{{ key }}" class="form-select" data-choices>
                                <option value="">{{ t('ui.common.select_placeholder', 'Select...') }}</option>
                                {% for opt in desc.get('options', []) %}
                                <option value="{{ opt }}" {% if env_vars.get(key) == opt %}selected{% endif %}>{{ opt }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="{{ desc.get('type', 'text') }}"
                                   name="env_{{ key }}"
                                   class="form-control"
                                   value="{{ env_vars.get(key, desc.get('default', '')) }}"
                                   placeholder="{{ t(desc_placeholder, desc_placeholder) }}">
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="amb-card">
                    <div class="amb-card-header">
                        <h5><i class="bi bi-shield-lock"></i> {{ t('ui.settings.web_access', 'Web UI Access') }}</h5>
                    </div>
                    <div class="amb-card-body">
                        {% for key in ['WEB_USER', 'WEB_PASSWORD'] %}
                        {% set desc = settings_desc.get(key, {}) %}
                        {% set desc_label = desc.get('label', key) %}
                        {% set desc_text = desc.get('description', '') %}
                        <div class="amb-form-group">
                            <label class="amb-form-label">{{ t(desc_label, desc_label) }}</label>
                            {% if desc_text %}
                            <p class="text-muted small mb-2">{{ t(desc_text, desc_text) }}</p>
                            {% endif %}
                            <input type="{{ desc.get('type', 'text') }}"
                                   name="env_{{ key }}"
                                   class="form-control"
                                   value="{{ env_vars.get(key, '') }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="amb-card">
            <div class="amb-card-header">
                <h5><i class="bi bi-sliders"></i> {{ t('ui.settings.other', 'Other Settings') }}</h5>
            </div>
            <div class="amb-card-body">
                <div class="row">
                    {% set known_keys = ['GITHUB_TOKEN', 'OPENAI_API_KEY', 'LITELLM_API_KEY', 'GITHUB_REPOSITORY', 'LOG_LEVEL', 'APP_LANG', 'PROMPT_PATH', 'WEB_USER', 'WEB_PASSWORD'] %}
                    {% for key, value in env_vars.items() %}
                    {% if key not in known_keys %}
                    <div class="col-md-6 col-lg-4">
                        <div class="amb-form-group">
                            {% set desc = settings_desc.get(key, {}) %}
                            {% set desc_label = desc.get('label', key) %}
                            {% set desc_text = desc.get('description', t('ui.settings.custom_default_desc', 'Custom environment setting. Add a description in metadata.json to show it here.')) %}
                            <label class="amb-form-label">{{ t(desc_label, desc_label) }}</label>
                            <p class="text-muted small mb-2">{{ t(desc_text, desc_text) }}</p>
                            <input type="text" name="env_{{ key }}" class="form-control" value="{{ value }}"
                                   placeholder="{{ t(desc.get('placeholder', ''), desc.get('placeholder', '')) }}">
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    <div class="col-md-6 col-lg-4">
                        <div class="amb-form-group">
                            <label class="amb-form-label">{{ t('ui.settings.add.title', 'Add New Setting') }}</label>
                            <p class="text-muted small mb-2">{{ t('ui.settings.add.desc', 'Use uppercase keys with underscores, like API_TIMEOUT.') }}</p>
                            <div class="input-group">
                                <input type="text" name="new_env_key" class="form-control" placeholder="{{ t('ui.settings.add.placeholder_key', 'KEY') }}">
                                <input type="text" name="new_env_value" class="form-control" placeholder="{{ t('ui.settings.add.placeholder_value', 'Value') }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="amb-card-footer">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save"></i> {{ t('ui.settings.save_all', 'Save All Settings') }}
                </button>
            </div>
        </div>
    </form>
</section>
{%- endmacro %}
